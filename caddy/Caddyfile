{
    auto_https off
    debug
    
}

# ===== External (behind HAProxy TLS) =====
http://{$CADDY_EXTERNAL_HOST} {
    encode gzip

    # Access log (per-virtual-host)
    log {
        output stdout
        format json
    }

    request_body {
        max_size 100MB
    }

    # Public static
    handle_path /static/* {
        root * /var/www/static
        file_server
    }

    # Media (auth via InvenTree /auth/)
    handle_path /media/* {
        root * /var/www/media
        file_server
        header Content-Disposition attachment
        forward_auth {$INVENTREE_SERVER} {
            uri /auth/
        }
    }

    # App
    reverse_proxy {$INVENTREE_SERVER} {
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host {host}
        header_up X-Real-IP {remote_host}
    }
}

# ===== Internal (LAN HTTP direct) =====
http://{$CADDY_INTERNAL_HOST} {
    encode gzip

    # Access log (per-virtual-host)
    log {
        output stdout
        format json
    }
    
    request_body {
        max_size 100MB
    }

    # Public static
    handle_path /static/* {
        root * /var/www/static
        file_server
    }

    # Media (auth via InvenTree /auth/)
    handle_path /media/* {
        root * /var/www/media
        file_server
        header Content-Disposition attachment
        forward_auth {$INVENTREE_SERVER} {
            uri /auth/
        }
    }

    # App
    reverse_proxy {$INVENTREE_SERVER} {
        header_up X-Forwarded-Proto http
        header_up X-Forwarded-Host {host}
        header_up X-Real-IP {remote_host}
    }
}

